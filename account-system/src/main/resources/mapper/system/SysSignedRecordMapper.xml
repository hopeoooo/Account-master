<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.account.system.mapper.SysSignedRecordMapper">

    <resultMap type="SysSignedRecord" id="SysSignedRecordResult">
    	<id     property="id"      column="id"      />
        <result property="userId"    column="user_id"    />
        <result property="signedAmount"     column="signed_amount"     />
        <result property="remark"      column="remark"      />
        <result property="createBy"      column="create_by"      />
        <result property="createTime"    column="create_time"    />
        <result property="updateBy"      column="update_by"      />
        <result property="updateTime"      column="update_time"      />
    </resultMap>
    <select id="selectSignedRecordList"   resultType="com.account.system.domain.vo.SysSignedRecordVo">
        SELECT
            m.id as id,
            m.`name` as userName,
            m.card as card,
            IFNULL(s.signed_amount,0) as signedAmount,
            s.remark as remark
        FROM
            sys_members m
        LEFT JOIN sys_signed_record s ON s.user_id = m.id
        <where>
            <if test="isAdmin != null and isAdmin != '' and isAdmin > 0">
                AND m.is_admin = 0
            </if>
            <if test="card != null and card != ''">
                AND m.card = #{card}
            </if>
        </where>
        ORDER BY s.signed_amount desc
    </select>


    <select id="selectSignedRecordTotal"  resultType="java.util.Map">
        SELECT
        SUM(s.signed_amount ) as signed_amount
        FROM
        sys_members m
        LEFT JOIN sys_signed_record s ON s.user_id = m.id
        <where>
            <if test="isAdmin != null and isAdmin != '' and isAdmin > 0">
                AND m.is_admin = 0
            </if>
            <if test="card != null and card != ''">
                AND m.card = #{card}
            </if>
        </where>
    </select>


    <select id="selectSignedRecordInfo" parameterType="SysSignedRecord" resultMap="SysSignedRecordResult">
        SELECT
        s.id,
        s.user_id,
        s.signed_amount
        FROM
        sys_signed_record s
        <where>
            <if test="userId != null and userId != '' ">
                and  s.user_id=#{userId}
            </if>
            <if test="id != null and id != '' ">
                and  s.id=#{id}
            </if>
        </where>
    </select>

    <insert id="insertSigned">
        INSERT INTO sys_signed_record
        (
        <if test="userId != null and userId != 0">user_id,</if>
        <if test="amount != null and amount != ''">signed_amount,</if>
        <if test="remark != null and remark != ''">remark,</if>
        <if test="createBy != null and createBy != ''">create_by,</if>
        create_time,update_time )
        values(
        <if test="userId != null and userId != ''">#{userId},</if>
        <if test="amount != null and amount != ''">#{amount},</if>
        <if test="remark != null and remark != ''">#{remark},</if>
        <if test="createBy != null and createBy != ''">#{createBy},</if>
        sysdate(),sysdate()
        )
    </insert>


    <update id="update" >
        update sys_signed_record
        <set>
            <if test="mark==1">
                <if test="amount != null and amount != ''">signed_amount=signed_amount+#{amount},</if>
            </if>
            <if test="mark==2">
                <if test="amount != null and amount != ''">signed_amount=signed_amount-#{amount},</if>
            </if>
            <if test="remark != null and remark != ''">remark=#{remark},</if>
            <if test="updateBy != null and updateBy != ''">update_by = #{updateBy},</if>
            update_time = sysdate()
        </set>
        where id = #{id} and user_id=#{userId}
    </update>
</mapper>